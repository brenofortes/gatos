<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#FEF9F4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Cat Weight">
<meta name="description" content="Acompanhe o peso dos seus gatos">
<title>Cat Weight - Peso dos Gatos</title>
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNhdCBXZWlnaHQgLSBQZXNvIGRvcyBHYXRvcyIsCiAgInNob3J0X25hbWUiOiAiQ2F0IFdlaWdodCIsCiAgImRlc2NyaXB0aW9uIjogIkFjb21wYW5oZSBvIHBlc28gZG9zIHNldXMgZ2F0aW5ob3MiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0ZFRjlGNCIsCiAgInRoZW1lX2NvbG9yIjogIiNGRUY5RjQiLAogICJpY29ucyI6IFtdCn0=">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'Nunito', 'Segoe UI', sans-serif;
    background: linear-gradient(160deg, #FEF9F4 0%, #F0F4FD 50%, #FDF2F8 100%);
    color: #2D3047;
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
    position: relative;
  }
  body::before, body::after {
    content: ''; position: fixed; border-radius: 50%; pointer-events: none; z-index: 0;
  }
  body::before {
    top: -120px; right: -80px; width: 350px; height: 350px;
    background: radial-gradient(circle, rgba(232,89,79,0.07) 0%, transparent 70%);
  }
  body::after {
    bottom: -100px; left: -60px; width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(27,168,160,0.06) 0%, transparent 70%);
  }
  .app { max-width: 720px; margin: 0 auto; padding: 28px 16px 120px; position: relative; z-index: 1; }

  @keyframes fadeUp { from { transform: translateY(16px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
  @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes slideOut { from { opacity: 1; } to { transform: translateX(100px); opacity: 0; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  .fade-up { animation: fadeUp 0.5s ease both; }

  .header { text-align: center; margin-bottom: 28px; }
  .header .paw { font-size: 48px; animation: float 3s ease-in-out infinite; }
  .header h1 {
    font-family: 'Fredoka One', cursive; font-size: 34px;
    background: linear-gradient(135deg, #E8594F, #E8A317, #1BA8A0);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }
  .header p { color: #A0A0B8; font-size: 14px; margin-top: 6px; font-weight: 700; }

  .sync-status {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 8px; padding: 4px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 700; transition: all 0.3s;
  }
  .sync-status.online { background: #E0F7F5; color: #1BA8A0; }
  .sync-status.offline { background: #FFF3E0; color: #E8A317; }
  .sync-status.syncing { background: #E8F4FD; color: #3498DB; }
  .sync-status.error { background: #FEE; color: #E8594F; }
  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }
  .sync-status.syncing .sync-dot { animation: spin 1s linear infinite; border: 2px solid currentColor; border-top-color: transparent; background: none; width: 10px; height: 10px; }

  .cat-cards { display: flex; gap: 12px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 6px; scroll-snap-type: x mandatory; }
  .cat-cards::-webkit-scrollbar { height: 0; }
  .cat-card {
    flex: 0 0 auto; min-width: 150px; padding: 18px 20px;
    background: #fff; border-radius: 18px; position: relative; overflow: hidden;
    scroll-snap-align: start; transition: transform 0.2s;
  }
  .cat-card:active { transform: scale(0.97); }
  .cat-card .blob { position: absolute; top: -25px; right: -25px; width: 70px; height: 70px; border-radius: 50%; }
  .cat-card .emoji { font-size: 30px; margin-bottom: 6px; }
  .cat-card .name { font-weight: 800; font-size: 15px; }
  .cat-card .weight-val { font-size: 26px; font-weight: 900; margin-top: 4px; }
  .cat-card .weight-val span { font-size: 13px; font-weight: 600; color: #999; }
  .cat-card .diff {
    display: inline-block; margin-top: 4px; padding: 2px 8px;
    border-radius: 6px; font-size: 12px; font-weight: 800;
  }
  .add-cat-btn {
    flex: 0 0 auto; min-width: 75px; padding: 18px 20px;
    background: #fff; border-radius: 18px; border: 2px dashed #ddd;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s; color: #bbb;
  }
  .add-cat-btn:hover { border-color: #1BA8A0; background: #F7FFFE; }
  .add-cat-btn .plus { font-size: 26px; }
  .add-cat-btn .label { font-size: 11px; font-weight: 700; }

  .panel {
    background: #fff; border-radius: 22px; padding: 24px;
    border: 1px solid #f0f0f4; box-shadow: 0 4px 24px rgba(0,0,0,0.04);
    margin-bottom: 16px; animation: fadeUp 0.4s ease both;
  }
  .panel-title { font-size: 17px; font-weight: 900; margin-bottom: 20px; }

  .form-label {
    font-size: 11px; font-weight: 800; color: #A0A0B8; display: block;
    margin-bottom: 7px; letter-spacing: 0.5px; text-transform: uppercase;
  }
  .form-input, .form-select {
    width: 100%; padding: 13px 16px; border-radius: 12px;
    border: 1.5px solid #E8E8EE; background: #FAFBFD;
    color: #2D3047; font-size: 14px; font-family: inherit; font-weight: 600;
    transition: all 0.2s; -webkit-appearance: none; appearance: none;
  }
  .form-input:focus, .form-select:focus {
    outline: none; box-shadow: 0 0 0 3px rgba(27,168,160,0.18); border-color: #1BA8A0;
  }
  .form-row { display: flex; gap: 12px; }
  .form-group { flex: 1; margin-bottom: 16px; }

  .btn-primary {
    width: 100%; padding: 15px; border-radius: 14px; border: none;
    background: linear-gradient(135deg, #E8594F, #E8A317);
    color: #fff; font-weight: 800; font-size: 15px; cursor: pointer;
    font-family: inherit; transition: all 0.2s;
    box-shadow: 0 6px 24px rgba(232,89,79,0.28);
  }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

  .btn-teal {
    padding: 11px 22px; border-radius: 12px; border: none;
    background: linear-gradient(135deg, #1BA8A0, #3498DB);
    color: #fff; font-weight: 800; cursor: pointer; font-size: 14px;
    font-family: inherit; box-shadow: 0 4px 14px rgba(27,168,160,0.3);
  }

  .bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid #f0f0f4; padding: 8px 16px;
    padding-bottom: max(8px, env(safe-area-inset-bottom));
    display: flex; gap: 4px; z-index: 100;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.04);
  }
  .nav-btn {
    flex: 1; padding: 10px 0; border-radius: 12px; border: none;
    background: transparent; color: #A0A0B8; font-weight: 800;
    cursor: pointer; font-size: 11px; font-family: inherit;
    display: flex; flex-direction: column; align-items: center; gap: 3px;
    transition: all 0.25s;
  }
  .nav-btn.active {
    background: linear-gradient(135deg, #1BA8A0, #3498DB);
    color: #fff; box-shadow: 0 4px 14px rgba(27,168,160,0.25);
  }
  .nav-btn .nav-icon { font-size: 20px; }
  .nav-btn .nav-label { font-size: 10px; }

  .record-item {
    display: flex; align-items: center; gap: 14px;
    padding: 14px 18px; border-radius: 14px;
    background: #FAFBFD; border: 1px solid #f0f0f4;
    transition: all 0.15s; margin-bottom: 8px;
  }
  .record-item:active { background: #F0F2F5; }
  .record-icon {
    width: 40px; height: 40px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .record-info { flex: 1; }
  .record-name { font-weight: 800; font-size: 14px; }
  .record-date { font-size: 12px; color: #A0A0B8; font-weight: 600; }
  .record-weight { font-weight: 900; font-size: 19px; }
  .record-weight span { font-size: 12px; font-weight: 600; color: #bbb; }
  .delete-btn {
    width: 30px; height: 30px; border-radius: 9px;
    border: 1.5px solid #fee; background: #FFF5F5;
    color: #E8594F; cursor: pointer; font-size: 13px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-weight: 700;
  }
  .delete-btn:active { background: #FEE; }

  .toast {
    position: fixed; top: 20px; right: 20px; z-index: 1000;
    color: #fff; padding: 12px 24px; border-radius: 14px; font-weight: 700;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12); font-size: 14px;
    animation: slideIn 0.3s ease;
  }
  .toast.hide { animation: slideOut 0.3s ease both; }

  .chart-container { width: 100%; overflow-x: auto; padding-bottom: 8px; }
  .chart-canvas { min-width: 100%; height: 260px; }
  .chart-legend { display: flex; gap: 16px; justify-content: center; margin-top: 16px; flex-wrap: wrap; }
  .chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 700; }
  .chart-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  .filter-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
  .filter-select {
    padding: 7px 14px; border-radius: 10px;
    border: 1.5px solid #E8E8EE; background: #FAFBFD;
    color: #2D3047; font-size: 12px; font-family: inherit; font-weight: 700;
  }

  .empty-state { text-align: center; padding: 40px 0; color: #bbb; }
  .empty-state .icon { font-size: 40px; margin-bottom: 8px; }
  .empty-state .text { font-weight: 700; }

  .add-cat-panel { margin-bottom: 16px; animation: fadeUp 0.3s ease both; }
  .add-cat-panel .row { display: flex; gap: 10px; }

  .footer { text-align: center; margin-top: 36px; font-size: 12px; color: #C8C8D8; font-weight: 700; }

  .loading-overlay {
    position: fixed; inset: 0; background: linear-gradient(160deg, #FEF9F4 0%, #F0F4FD 50%, #FDF2F8 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999; transition: opacity 0.4s;
  }
  .loading-overlay.fade-out { opacity: 0; pointer-events: none; }
  .loading-spinner { font-size: 48px; animation: float 1.5s ease-in-out infinite; }
  .loading-text { font-family: 'Fredoka One', cursive; font-size: 20px; color: #1BA8A0; margin-top: 12px; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner">üêæ</div>
  <div class="loading-text">Carregando...</div>
</div>

<div class="app" id="app">
  <div class="header fade-up">
    <div class="paw">üêæ</div>
    <h1>Cat Weight</h1>
    <p>Acompanhe a sa√∫de dos seus gatinhos</p>
    <div class="sync-status syncing" id="syncStatus">
      <div class="sync-dot"></div>
      <span>Conectando...</span>
    </div>
  </div>

  <div class="cat-cards" id="catCards"></div>

  <div class="panel add-cat-panel hidden" id="addCatPanel">
    <div class="panel-title">üêà Adicionar novo gato</div>
    <div class="row">
      <input class="form-input" id="newCatName" placeholder="Nome do gato" style="flex:1">
      <button class="btn-teal" onclick="addCat()">Adicionar</button>
    </div>
  </div>

  <div id="tabRegistro">
    <div class="panel">
      <div class="panel-title">Novo registro de peso</div>
      <div class="form-group">
        <label class="form-label">Gato</label>
        <select class="form-select" id="selectCat"><option value="">Selecione o gato...</option></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Data</label>
          <input type="date" class="form-input" id="inputDate">
        </div>
        <div class="form-group">
          <label class="form-label">Peso (kg)</label>
          <input type="number" step="0.1" min="0" max="30" class="form-input" id="inputWeight" placeholder="Ex: 4.5">
        </div>
      </div>
      <button class="btn-primary" onclick="addRecord()" id="btnRecord">üêæ Registrar Peso</button>
    </div>
  </div>

  <div id="tabGrafico" class="hidden">
    <div class="panel">
      <div class="panel-title">Evolu√ß√£o de peso</div>
      <div class="chart-container">
        <canvas id="chartCanvas" class="chart-canvas"></canvas>
      </div>
      <div class="chart-legend" id="chartLegend"></div>
    </div>
  </div>

  <div id="tabHistorico" class="hidden">
    <div class="panel">
      <div class="filter-row">
        <div class="panel-title" style="margin-bottom:0">Hist√≥rico</div>
        <select class="filter-select" id="filterCat" onchange="renderHistory()">
          <option value="todos">Todos</option>
        </select>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <div class="footer">Feito com üíú para os gatinhos</div>
</div>

<div class="bottom-nav">
  <button class="nav-btn active" data-tab="tabRegistro" onclick="switchTab('tabRegistro', this)">
    <span class="nav-icon">üìù</span><span class="nav-label">Registrar</span>
  </button>
  <button class="nav-btn" data-tab="tabGrafico" onclick="switchTab('tabGrafico', this)">
    <span class="nav-icon">üìä</span><span class="nav-label">Gr√°fico</span>
  </button>
  <button class="nav-btn" data-tab="tabHistorico" onclick="switchTab('tabHistorico', this)">
    <span class="nav-icon">üìã</span><span class="nav-label">Hist√≥rico</span>
  </button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// ==================== FIREBASE INIT ====================
firebase.initializeApp({
  apiKey: "AIzaSyBm03WXi_WVoC-h-aQWREhNuekPHZ22jWE",
  authDomain: "gatos-d453c.firebaseapp.com",
  projectId: "gatos-d453c"
});

var db = firebase.firestore();

// Enable offline persistence ‚Äî wrapped safely
try { db.enablePersistence().catch(function(){}); } catch(e) {}

var catsCol = db.collection('cats');
var recordsCol = db.collection('records');

// ==================== CONSTANTS ====================
var CAT_COLORS = ["#E8594F","#1BA8A0","#E8A317","#7C5CE7","#2ECC71","#E67E22","#3498DB","#E84393"];
var CAT_EMOJIS = ["üê±","üò∫","üò∏","üêà","üòª","üôÄ","üòΩ","üòº"];

// ==================== STATE ====================
var cats = [];
var records = [];
var isLoaded = false;
var catsLoaded = false;
var recordsLoaded = false;

// ==================== SYNC STATUS ====================
function setSyncStatus(status) {
  var el = document.getElementById('syncStatus');
  if (!el) return;
  el.className = 'sync-status ' + status;
  var labels = { online: 'Sincronizado', offline: 'Offline', syncing: 'Sincronizando...', error: 'Erro de conex√£o' };
  el.innerHTML = '<div class="sync-dot"></div><span>' + (labels[status] || status) + '</span>';
}

function hideLoading() {
  if (isLoaded) return;
  isLoaded = true;
  var overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.add('fade-out');
    setTimeout(function() { overlay.style.display = 'none'; }, 400);
  }
  renderAll();
}

function checkAllLoaded() {
  if (catsLoaded && recordsLoaded) {
    hideLoading();
    setSyncStatus('online');
  }
}

// ==================== FIRESTORE LISTENERS ====================
function setupListeners() {
  // Cats listener ‚Äî no orderBy (avoids needing composite index)
  catsCol.onSnapshot(function(snapshot) {
    cats = [];
    snapshot.forEach(function(doc) {
      cats.push({ id: doc.id, name: doc.data().name, emoji: doc.data().emoji, createdAt: doc.data().createdAt });
    });
    cats.sort(function(a, b) { return (a.name || '').localeCompare(b.name || ''); });
    catsLoaded = true;
    checkAllLoaded();
    if (isLoaded) renderAll();
  }, function(err) {
    console.error('Cats listener error:', err);
    catsLoaded = true;
    checkAllLoaded();
    setSyncStatus('error');
  });

  // Records listener ‚Äî no orderBy
  recordsCol.onSnapshot(function(snapshot) {
    records = [];
    snapshot.forEach(function(doc) {
      records.push({ id: doc.id, catId: doc.data().catId, date: doc.data().date, weight: doc.data().weight });
    });
    records.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
    recordsLoaded = true;
    checkAllLoaded();
    if (isLoaded) renderAll();
  }, function(err) {
    console.error('Records listener error:', err);
    recordsLoaded = true;
    checkAllLoaded();
    setSyncStatus('error');
  });

  window.addEventListener('online', function() { setSyncStatus('online'); });
  window.addEventListener('offline', function() { setSyncStatus('offline'); });
}

// ==================== HELPERS ====================
function formatDate(d) {
  if (!d) return '-';
  return new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
}
function formatDateFull(d) {
  if (!d) return '-';
  return new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function getCatStats(catId) {
  var recs = records.filter(function(r) { return r.catId === catId; }).sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); });
  if (!recs.length) return null;
  var latest = recs[recs.length - 1];
  var prev = recs.length > 1 ? recs[recs.length - 2] : null;
  var diff = prev ? (latest.weight - prev.weight).toFixed(2) : null;
  return { latest: latest.weight, diff: diff, count: recs.length };
}

function getCatColor(catId) {
  var idx = cats.findIndex(function(c) { return c.id === catId; });
  return CAT_COLORS[Math.max(0, idx) % CAT_COLORS.length];
}

// ==================== TOAST ====================
function showToast(msg, type) {
  type = type || 'success';
  var existing = document.querySelector('.toast');
  if (existing) existing.remove();
  var t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  t.style.background = type === 'error' ? '#E8594F' : type === 'info' ? '#3498DB' : '#1BA8A0';
  document.body.appendChild(t);
  setTimeout(function() { t.classList.add('hide'); setTimeout(function() { t.remove(); }, 300); }, 2300);
}

// ==================== RENDER ====================
function renderCatCards() {
  var container = document.getElementById('catCards');
  if (!container) return;
  var html = '';
  cats.forEach(function(cat, i) {
    var stats = getCatStats(cat.id);
    var color = CAT_COLORS[i % CAT_COLORS.length];
    html += '<div class="cat-card" style="border:1.5px solid ' + color + '20; box-shadow: 0 4px 20px ' + color + '10, 0 1px 3px rgba(0,0,0,0.04); animation: fadeUp ' + (0.4 + i*0.1) + 's ease both;">';
    html += '<div class="blob" style="background:' + color + '0A"></div>';
    html += '<div class="emoji">' + (cat.emoji || 'üê±') + '</div>';
    html += '<div class="name">' + (cat.name || '?') + '</div>';
    if (stats) {
      html += '<div class="weight-val" style="color:' + color + '">' + stats.latest + '<span> kg</span></div>';
      if (stats.diff) {
        var v = parseFloat(stats.diff);
        var bg = v > 0 ? '#FFF3E0' : v < 0 ? '#E0F7F5' : '#F5F5F5';
        var cl = v > 0 ? '#E8A317' : v < 0 ? '#1BA8A0' : '#999';
        var arrow = v > 0 ? '‚ñ≤' : v < 0 ? '‚ñº' : '=';
        html += '<div class="diff" style="background:' + bg + ';color:' + cl + '">' + arrow + ' ' + Math.abs(v) + ' kg</div>';
      }
    } else {
      html += '<div style="font-size:12px;color:#bbb;margin-top:8px">Sem registros</div>';
    }
    html += '</div>';
  });
  html += '<div class="add-cat-btn" onclick="toggleAddCat()"><div class="plus">+</div><div class="label">Novo</div></div>';
  container.innerHTML = html;
}

function renderSelects() {
  var sel = document.getElementById('selectCat');
  if (sel) {
    sel.innerHTML = '<option value="">Selecione o gato...</option>';
    cats.forEach(function(c) { sel.innerHTML += '<option value="' + c.id + '">' + (c.emoji || 'üê±') + ' ' + c.name + '</option>'; });
  }
  var filt = document.getElementById('filterCat');
  if (filt) {
    filt.innerHTML = '<option value="todos">Todos</option>';
    cats.forEach(function(c) { filt.innerHTML += '<option value="' + c.id + '">' + c.name + '</option>'; });
  }
}

function toggleAddCat() {
  document.getElementById('addCatPanel').classList.toggle('hidden');
  document.getElementById('newCatName').focus();
}

// ==================== FIRESTORE OPERATIONS ====================
function addCat() {
  var nameInput = document.getElementById('newCatName');
  var name = nameInput.value.trim();
  if (!name) return;
  var emoji = CAT_EMOJIS[cats.length % CAT_EMOJIS.length];

  setSyncStatus('syncing');
  catsCol.add({
    name: name,
    emoji: emoji,
    createdAt: new Date().toISOString()
  }).then(function() {
    nameInput.value = '';
    document.getElementById('addCatPanel').classList.add('hidden');
    showToast(name + ' adicionado! üéâ');
    setSyncStatus('online');
  }).catch(function(err) {
    console.error('Error adding cat:', err);
    showToast('Erro ao adicionar gato', 'error');
    setSyncStatus('error');
  });
}

function addRecord() {
  var catId = document.getElementById('selectCat').value;
  var date = document.getElementById('inputDate').value;
  var weight = parseFloat(document.getElementById('inputWeight').value);

  if (!catId || !date) { showToast('Preencha todos os campos!', 'error'); return; }
  if (isNaN(weight) || weight <= 0 || weight > 30) { showToast('Peso inv√°lido!', 'error'); return; }

  var btn = document.getElementById('btnRecord');
  btn.disabled = true;
  setSyncStatus('syncing');

  recordsCol.add({
    catId: catId,
    date: date,
    weight: weight,
    createdAt: new Date().toISOString()
  }).then(function() {
    document.getElementById('inputWeight').value = '';
    showToast('Peso registrado! üêæ');
    setSyncStatus('online');
    btn.disabled = false;
  }).catch(function(err) {
    console.error('Error adding record:', err);
    showToast('Erro ao registrar peso', 'error');
    setSyncStatus('error');
    btn.disabled = false;
  });
}

function deleteRecord(id) {
  if (!confirm('Remover este registro?')) return;
  setSyncStatus('syncing');
  recordsCol.doc(id).delete().then(function() {
    showToast('Registro removido', 'info');
    setSyncStatus('online');
  }).catch(function(err) {
    console.error('Error deleting:', err);
    showToast('Erro ao remover', 'error');
    setSyncStatus('error');
  });
}

// ==================== HISTORY ====================
function renderHistory() {
  var filter = document.getElementById('filterCat').value;
  var list = document.getElementById('historyList');
  if (!list) return;
  var filtered = records.slice().sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
  if (filter !== 'todos') filtered = filtered.filter(function(r) { return r.catId === filter; });

  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><div class="text">Nenhum registro encontrado</div></div>';
    return;
  }
  var html = '';
  filtered.forEach(function(rec, i) {
    var cat = cats.find(function(c) { return c.id === rec.catId; });
    var color = getCatColor(rec.catId);
    html += '<div class="record-item" style="animation: fadeUp ' + (0.2 + i*0.04) + 's ease both">';
    html += '<div class="record-icon" style="background:' + color + '12">' + (cat ? cat.emoji : 'üê±') + '</div>';
    html += '<div class="record-info">';
    html += '<div class="record-name">' + (cat ? cat.name : '?') + '</div>';
    html += '<div class="record-date">' + formatDateFull(rec.date) + '</div>';
    html += '</div>';
    html += '<div class="record-weight" style="color:' + color + '">' + rec.weight + '<span> kg</span></div>';
    html += '<button class="delete-btn" onclick="deleteRecord(\'' + rec.id + '\')">‚úï</button>';
    html += '</div>';
  });
  list.innerHTML = html;
}

// ==================== CHART ====================
function renderChart() {
  var canvas = document.getElementById('chartCanvas');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 260 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '260px';
  ctx.scale(dpr, dpr);

  var W = rect.width, H = 260;
  var pad = { top: 20, right: 20, bottom: 40, left: 50 };
  var cW = W - pad.left - pad.right;
  var cH = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);

  var dateSet = {};
  records.forEach(function(r) { if (r.date) dateSet[r.date] = true; });
  var allDates = Object.keys(dateSet).sort();

  if (!allDates.length) {
    ctx.fillStyle = '#bbb'; ctx.font = '700 14px Nunito'; ctx.textAlign = 'center';
    ctx.fillText('Nenhum registro ainda', W/2, H/2);
    return;
  }

  var allWeights = records.map(function(r) { return r.weight; });
  var minW = Math.min.apply(null, allWeights) - 0.5;
  var maxW = Math.max.apply(null, allWeights) + 0.5;
  if (maxW - minW < 1) { minW -= 0.5; maxW += 0.5; }

  var numLines = 5;
  ctx.strokeStyle = '#f0f0f4'; ctx.lineWidth = 1;
  for (var i = 0; i <= numLines; i++) {
    var y = pad.top + (cH / numLines) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    var val = (maxW - (maxW - minW) * (i / numLines)).toFixed(1);
    ctx.fillStyle = '#A0A0B8'; ctx.font = '600 11px Nunito'; ctx.textAlign = 'right';
    ctx.fillText(val + ' kg', pad.left - 8, y + 4);
  }

  ctx.textAlign = 'center';
  allDates.forEach(function(d, i) {
    var x = pad.left + (cW / Math.max(allDates.length - 1, 1)) * i;
    ctx.fillStyle = '#A0A0B8'; ctx.font = '600 11px Nunito';
    ctx.fillText(formatDate(d), x, H - pad.bottom + 20);
  });

  cats.forEach(function(cat, ci) {
    var color = CAT_COLORS[ci % CAT_COLORS.length];
    var catRecs = allDates.map(function(d) {
      var r = records.find(function(rec) { return rec.catId === cat.id && rec.date === d; });
      return r ? r.weight : null;
    });

    ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    ctx.beginPath();
    var started = false;
    catRecs.forEach(function(w, i) {
      if (w === null) return;
      var x = pad.left + (cW / Math.max(allDates.length - 1, 1)) * i;
      var y = pad.top + cH - ((w - minW) / (maxW - minW)) * cH;
      if (!started) { ctx.moveTo(x, y); started = true; }
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    catRecs.forEach(function(w, i) {
      if (w === null) return;
      var x = pad.left + (cW / Math.max(allDates.length - 1, 1)) * i;
      var y = pad.top + cH - ((w - minW) / (maxW - minW)) * cH;
      ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fillStyle = color; ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 2.5; ctx.stroke();
    });
  });

  var legend = document.getElementById('chartLegend');
  if (legend) {
    legend.innerHTML = cats.map(function(c, i) {
      return '<div class="chart-legend-item"><div class="chart-legend-dot" style="background:' + CAT_COLORS[i % CAT_COLORS.length] + '"></div>' + c.name + '</div>';
    }).join('');
  }
}

// ==================== TABS ====================
function switchTab(tabId, btn) {
  ['tabRegistro', 'tabGrafico', 'tabHistorico'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
  var target = document.getElementById(tabId);
  if (target) target.classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  if (tabId === 'tabGrafico') setTimeout(renderChart, 50);
  if (tabId === 'tabHistorico') renderHistory();
}

function renderAll() {
  renderCatCards();
  renderSelects();
  renderHistory();
  var activeBtn = document.querySelector('.nav-btn.active');
  var activeTab = activeBtn ? activeBtn.getAttribute('data-tab') : '';
  if (activeTab === 'tabGrafico') renderChart();
}

// ==================== INIT ====================
document.getElementById('inputDate').value = new Date().toISOString().slice(0, 10);
document.getElementById('newCatName').addEventListener('keydown', function(e) { if (e.key === 'Enter') addCat(); });
document.getElementById('inputWeight').addEventListener('keydown', function(e) { if (e.key === 'Enter') addRecord(); });
window.addEventListener('resize', function() {
  var tab = document.getElementById('tabGrafico');
  if (tab && !tab.classList.contains('hidden')) renderChart();
});

// Start listeners
setupListeners();

// Fallback: hide loading after 4s
setTimeout(function() {
  if (!isLoaded) {
    hideLoading();
    if (!navigator.onLine) setSyncStatus('offline');
  }
}, 4000);
</script>
</body>
</html>
